
 # 데이터 압축
 
---------------------------------------------------------------------------------------------------------------------------------------

> ## 데이터 압축

### 개요
- MySQL 서버에서 디스크에 저장딘 데이터 파일의 크기는 쿼리의 처리 성능과도 직결되지만 백업 & 복구 시간과도 연결된다
  - 더 많은 데이터 페이지를 InnoDB 버퍼 풀로 읽어야 할 수 있다
  - 더티 페이지가 더 자주 디스크로 기록돼야 한다


### 더티 페이지
- 디스크의 저장된 내용과 다른 InnoDB 버퍼 풀에 저장된 페이지
- 캐쉬를 사용하기 때문에 이런 페이지가 발생될 수 있다


### 압축 방식
1. 테이블 압축
2. 페이지 압축

---------------------------------------------------------------------------------------------------------------------------------------

> ## 페이지 압축

### 페이지 압축 Transparent Page Compression
- MySQL 서버가 디스크에 저장하는 시점에 데이터 페이지가 압축되어 저장되고, MySQL 서버가 디스크에서 데이터 페이지를 읽어올 때 압축이 해제
- 버퍼 풀에 데이터 페이지가 한번 적재되면 InnoDB 스토리지 엔진은 압축이 해제된 상태로만 데이터 페이지를 관리한다
- 운영체제별로 특정 버전의 파일 시스템에서만 지원하는 펀치 홀이라는 기능을 사용한다


### 페이지 압축 과정
1. 16KB 페이지를 압축(압축 결과를 7KB로 가정)
2. MySQl 서버는 디스크에 압축된 결과 7KB를 기록 (데이터 7KB + 빈 데이터 9KB)
3. 디스크에 데이터를 기록한 후, 7KB 이후의 공간 9KB에 대해 펀치 홀(Punch-hole)을 생성
4. 파일 시스템은 7KB만 남기고 나머지 디스크의 9KB 공간은 다시 운영체제로 반납


### 주의사항
- 펀치 홀 기능이 운영체제뿐만 아니라 하드웨어 자체에서도 지원해야 한다
- 백업이나 복구과정에서 펀치 홀이 다시 채워져서 원본 크기 16KB로 돌아올 수 있다
- 이러한 문제들로 페이지 압축은 많이 사용되지 않는다


### 페이지 압축 설정 방법
    // 테이블 생성 시
    CREATE TABLE t1 (c1 INT) COMPRESSION="zlib";

    // 테이블 변경 시
    ALTER TABLE t1 COMPRESSION="zlib";

---------------------------------------------------------------------------------------------------------------------------------------

> ## 테이블 압축

### 테이블 압축
- 운영체제나 하드웨어에 대한 제약 없이 사용할 수 있기 때문에 일반적으로 더 활용도가 높은 편이다


### 테이블 압축 단점
- 버퍼 풀 공간 활용률이 낮음
- 쿼리 처리 성능이 낮음
- 빈번한 데이터 변경 시 압축률이 떨어짐


### 테이블 압축 전제 조건
- 압축을 사용하려는 테이블이 별도의 테이블 스페이스를 사용해야 한다


### 테이블 압축 과정
1. 16KB의 데이터 페이지를 압축
    - 압축된 결과가 8KB 이하이면 그대로 디스크에 저장(압축 완료)
    - 압축된 결과가 8KB 초과하면 원본 페이지를 스플릿(split)해서 2개의 페이지에 8KB씩 저장
2. 나뉜 페이지 각각에 대해 "1"번 단계를 반복 실행


### KEY_BLOCK_SIZE
- 압축된 페이지가 저장될 페이지의 크기를 지정한다 (2n으로만 설정할 수 있다, n >= 2)
- 페이지 크기가 32KB OR 64KB인 경우에는 테이블 압축을 적용할 수 없다
- KEY_BLOCK_SIZE에 따라 성능이 좌우되므로 최소한 데이터 페이지 10개 이상은 생성되도록 테스트 데이터를 INSERT 해보는 것이 좋다
  - 실패율은 3~5% 미만으로 유지할 수 있게 KEY_BLOCK_SIZE를 선택하는 것이 좋다


### 버퍼 풀에서 압축 데이터 관리
- 압축된 테이블의 데이터 페이지를 버퍼 풀에 적재하면 압축된 상태와 압축이 해제된 상태 2개 버전을 관리한다
- LRU 리스트
  - 디스크에서 읽은 상태 그대로의 데이터 페이지 목록
    - 압축이 적용되지 않은 테이블의 데이터 페이지
    - 압축이 적용된 테이블의 압축된 데이터 페이지
- Unzip_LRU
  - 압축된 페이지들의 압축 해제 버전 리스트


### 테이블 압축 문제점
- 버퍼 풀의 공간을 이중으로 사용함으로써 메모리를 낭비하게 된다
- 압축된 페이지에서 데이터를 읽거나 변경하기 위해서는 압축을 해제해야 한다
- 이러한 문제점을 보완하기 위해 Unzip_LRU 리스트를 별도로 관리하고 있다가 적절히 사용한다


### Unzip_LRU 활용
- 버퍼 풀의 공간이 필요한 경우 Unzip_LRU 리스트에서 압축 해재된 버전을 제거해서 버퍼 풀의 공간을 확보한다
- 압축된 데이터 페이지가 자주 사용되는 경우 Unzip_LRU 리스트를 삭제하지 않고 계속 유지한다
- 압축된 데이터 페이지가 사용되지 않아 LRU 리스트에서 제거되는 경우 Unzip_LRU 리스트에서도 제거한다


### 테이블 압축 팁
- CPU 사용량이 높은 서버에서는 가능하면 압축, 압축 해제를 피하기 위해 Unzip_LRU의 비율을 높여서 유지
- Disk IO 사용량이 높은 서버에서는 가능하면 Unzip_LRU 리스트의 비율을 낮춰서 버퍼 풀의 공간을 더 확보하자

























