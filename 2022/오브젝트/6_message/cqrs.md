# CQRS 아는 척하기.

----------------------------------------------------------------------------------------------------

> ## CQRS 아는 척하기 1.

### CQRS Command Query Responsibility Segregation.
- 명령(시스템 데이터 변경) 역할을 수행하는 구성 요소와 쿼리(시스템 데이터 조회) 역할을 수행하고 구성요소를 나누는 것.
- 시스템 데이터를 변경하는 코드와 시스템 데이터를 조회하는 코드를 따로 나누는 것.

### 명령과 쿼리.
- 명령 Command.
  - 시스템 데이터 변경.
  - 예 : 주문취소, 배송완료.
- 쿼리 Query.
  - 시스템 데이터 조회.
  - 예 : 주문 목록. 

### 책임 분리.
- 책임 Responsibility.
  - 구성 요소의 역할.
  - 구성 요소 (모델)
    - 클래스, 함수.
    - 모듈, 패키지.
    - 웹서버, DB.
- 분리 Segregation.
  - 역할게 따라 구성 요소 나누기.

### 명령과 조회에 단일 모델을 사용하면 ?
- 코드 역할, 책임 모호.
- 의미, 가동성 등 나빠짐.
- 유지보수성이 떨어짐.

### 명령과 쿼리를 분리해야 되는 이유.
- 명령과 쿼리는 다루는 데이터가 다름.
  - 명령 : 한 영역의 데이터.
  - 쿼리 : 여러 영역의 데이터.
- 명령과 쿼리는 코드 변경 빈도, 사용자 다름.
  - 변경 빈도가 다른 기능이 한 코드에 있으면 발생하는 문제.
    - 서로 다른 이유로 코드가 바뀜.
    - 이는 곧 책임의 크기가 적당하지 않다는 것.
- 기능마다 성능 요구가 다름.
  - 기능마다 트래픽 패턴, 성능 요구 다름.
    - 사용자의 댓글 등록.
    - 사용자의 주문.
    - 백오피스의 판매 수치.
  - 기능마다 서로 다른 성능 향상 방법 필요.
    - 단일 모델로는 다양한 성능 향상 기법 적용이 어려울 수 있음.

----------------------------------------------------------------------------------------------------

> ## CQRS 아는 척하기 2.

### 같은 프로세스, 같은 DB에서 사용하기.
- 가장 단순.
- 명령, 쿼리 동일 데이터 보장.

### 같은 프로세스, 같은 DB, 다른 테이블.
- 쿼리 전용 데이블 사용.
  - 최근 조회수 많은 글 목록.
- 명령이 쿼리 전용 데이터 변경 유발.

### 같은 프로세스, 다른 DB.
- 쿼리는 redis같은 다른 쿼리를 사용하는 방법.
- 명령을 통해 데이터가 변경되면 쿼리 DB로 데이터를 전파.

### 다른 프로세스, 다른 DB.
- 명령을 통해 데이터가 변경되면 쿼리 DB로 데이터를 전파.

### 다른 DB로 변경 전파.
- 명령이 직접 다른 DB를 수정하는 방식.
  - 구현이 단순하다.
  - 데이터 유실 가능성이 있다.
- 변경 내역을 기억하고 별도 전파기를 이용하는 방식.
  - 명령 DB에 데이터를 저장하고, 전파기를 통해 다른 DB에 데이터를 수정하는 방식.
- DB가 제공하는 CDC를 사용하는 방식.
  - 명령 DB에 데이터를 저장하고, CDC 기능을 활용해 다른 DB에 데이터를 수정하는 방식. 
  - CDC Change Data Capture.
    - DB의 로그 파일을 분섟해 변경된 데이터를 추출하는 기술이다.

### 다른 DB 사용시 주의 사항.
- 데이터 유실.
  - 유실 허용 여부에 따라 DB 트랜잭션 범위 중요.
- 허용 가능 지연 시간.
- 중복 전달.
- 추가적인 오류는 메세징에 대해 찾아보기.

### 출처.
1. https://martinfowler.com/bliki/CQRS.html








